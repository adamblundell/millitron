<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Millitron Quality - Email Entry</title>
<style>
body { font-family: sans-serif; margin:0; padding:20px; background:#f5f5f5; }
h1,h2 { text-align:center; }
input, button { font-size:18px; padding:10px; margin:5px; width:90%; max-width:300px; box-sizing:border-box; }
button { cursor:pointer; }
.center { display:flex; justify-content:center; align-items:center; flex-direction:column; }
.row { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin:10px 0; }
.photos { display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:10px 0; }
.photos img { max-width:120px; cursor:pointer; border:1px solid #ccc; }
.list-entry { display:flex; flex-direction:column; align-items:center; margin-bottom:15px; width:100%; max-width:300px; }
.hidden { display:none; }
.small-muted { font-size:12px; color:#666; text-align:center; margin-top:6px; }
</style>

<!-- Latest EmailJS SDK -->
<script type="text/javascript" src="https://cdn.emailjs.com/sdk/3.14.0/email.min.js"></script>
</head>
<body>

<!-- Login Page -->
<div id="loginPage" class="center">
  <h1>Millitron Quality v3</h1>
  <input type="text" id="loginUser" placeholder="Username">
  <input type="password" id="loginPass" placeholder="Password">
  <div class="row">
    <button id="loginBtn">Login</button>
  </div>
</div>

<!-- Add Entry Page -->
<div id="addEntryPage" class="center hidden">
  <h2>Add Production Entry</h2>
  <div class="list-entry"><label>Production Order:</label><input type="text" id="prodOrder"></div>
  <div class="list-entry"><label>DR Number:</label><input type="text" id="drNumber"></div>
  <div class="list-entry">
    <label>Photos (3+):</label>
    <input type="file" id="photo1" accept="image/*">
    <input type="file" id="photo2" accept="image/*">
    <input type="file" id="photo3" accept="image/*">
    <div class="photos" id="photoPreview"></div>
    <div class="small-muted">Tip: after selecting each photo, wait a moment for preview.</div>
  </div>
  <div class="row">
    <button id="sendEmailBtn">Send Entry via Email</button>
    <button id="logoutBtn">Logout</button>
    <button id="userMgmtBtn" class="hidden">User Management</button>
  </div>
</div>

<!-- User Management Page -->
<div id="userMgmtPage" class="center hidden">
  <h2>User Management</h2>
  <div id="userList"></div>
  <div class="list-entry">
    <label>New Username:</label>
    <input type="text" id="newUsername">
    <label>New Password:</label>
    <input type="text" id="newPassword">
    <button id="addUserBtn">Add User</button>
  </div>
  <div class="row">
    <button id="backBtn">Back</button>
  </div>
</div>

<script>
window.onload = function() {

  // Initialize EmailJS
  emailjs.init('GM8geKKfTUv87uZu3');

  /* ---------- USERS ---------- */
  let users = JSON.parse(localStorage.getItem('users')) || [
    {username:"Admin", password:"AB4826"},
    {username:"Dave", password:"Quality"},
    {username:"John", password:"Password123"},
    {username:"Jane", password:"SecurePass"},
    {username:"Alex", password:"Alex2025"}
  ];

  function saveUsers() { localStorage.setItem('users', JSON.stringify(users)); }

  /* ---------- NAV & AUTH ---------- */
  function login(){
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value;
    const found = users.find(x => x.username === u && x.password === p);
    if(found){
      localStorage.setItem('currentUser', u);
      showAddEntry();
      if(u === "Admin") document.getElementById('userMgmtBtn').classList.remove('hidden');
    } else alert('Invalid credentials.');
  }

  function hideAll(){ ['loginPage','addEntryPage','userMgmtPage'].forEach(id=>document.getElementById(id).classList.add('hidden')); }
  function showAddEntry(){ hideAll(); document.getElementById('addEntryPage').classList.remove('hidden'); }

  /* ---------- USER MANAGEMENT ---------- */
  function showUserMgmt() {
    hideAll();
    document.getElementById('userMgmtPage').classList.remove('hidden');
    renderUserList();
  }

  function renderUserList() {
    const container = document.getElementById('userList');
    container.innerHTML = '';
    users.forEach((u, i) => {
      const div = document.createElement('div');
      div.className = 'list-entry';
      div.innerHTML = `
        <span><strong>${u.username}</strong>: ${u.password}</span>
        <button onclick="editUser(${i})">Edit</button>
        <button onclick="deleteUser(${i})">Delete</button>
      `;
      container.appendChild(div);
    });
  }

  function addUser() {
    const newU = document.getElementById('newUsername').value.trim();
    const newP = document.getElementById('newPassword').value.trim();
    if(!newU || !newP) return alert('Enter username and password');
    if(users.find(x => x.username === newU)) return alert('Username already exists');
    users.push({username:newU, password:newP});
    saveUsers();
    renderUserList();
    document.getElementById('newUsername').value='';
    document.getElementById('newPassword').value='';
  }

  function editUser(index) {
    const newPass = prompt('Enter new password for ' + users[index].username, users[index].password);
    if(newPass !== null && newPass.trim() !== '') {
      users[index].password = newPass.trim();
      saveUsers();
      renderUserList();
    }
  }

  function deleteUser(index) {
    if(users[index].username === 'Admin') return alert('Cannot delete Admin');
    if(confirm(`Delete user ${users[index].username}?`)) {
      users.splice(index,1);
      saveUsers();
      renderUserList();
    }
  }

  /* ---------- PHOTO HANDLING ---------- */
  const photoInputs = ['photo1','photo2','photo3'];
  let photoFiles = [];

  photoInputs.forEach(id => {
    document.getElementById(id).addEventListener('change', e => {
      const file = e.target.files[0];
      if(!file) return;
      photoFiles.push(file);
      const previewUrl = URL.createObjectURL(file);
      const img = document.createElement('img');
      img.src = previewUrl;
      img.addEventListener('click', ()=> window.open(previewUrl));
      document.getElementById('photoPreview').appendChild(img);
    });
  });

  /* ---------- SEND EMAIL WITH ATTACHMENTS ---------- */
  function sendEmail() {
    const prodOrder = document.getElementById('prodOrder').value.trim();
    const drNumber = document.getElementById('drNumber').value.trim();
    if(!prodOrder || !drNumber) return alert('Fill all fields');
    if(photoFiles.length < 3) return alert('Select at least 3 photos');

    const currentUser = localStorage.getItem('currentUser') || 'Unknown';

    const attachmentsPromises = photoFiles.map(file => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64Data = reader.result.split(',')[1] || reader.result;
          resolve({name: file.name, data: base64Data});
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    });

    Promise.all(attachmentsPromises)
      .then(attachments => {
        const templateParams = {
          prodOrder: prodOrder,
          drNumber: drNumber,
          user: currentUser,
          attachments: attachments
        };

        emailjs.send('service_l486r2y','template_z9ceflo', templateParams)
          .then(response => {
            alert('Email sent successfully!');
            document.getElementById('prodOrder').value='';
            document.getElementById('drNumber').value='';
            photoFiles = [];
            document.getElementById('photoPreview').innerHTML='';
          })
          .catch(error => {
            console.error('EmailJS error:', error);
            alert('Failed to send email: ' + JSON.stringify(error));
          });
      })
      .catch(err => {
        console.error('Attachment error:', err);
        alert('Failed to process attachments: ' + err);
      });
  }

  /* ---------- BUTTONS ---------- */
  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('sendEmailBtn').addEventListener('click', sendEmail);
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('currentUser');
    hideAll();
    document.getElementById('loginPage').classList.remove('hidden');
    document.getElementById('prodOrder').value='';
    document.getElementById('drNumber').value='';
    photoFiles = [];
    document.getElementById('photoPreview').innerHTML='';
    document.getElementById('userMgmtBtn').classList.add('hidden');
  });

  document.getElementById('userMgmtBtn').addEventListener('click', showUserMgmt);
  document.getElementById('backBtn').addEventListener('click', showAddEntry);
  document.getElementById('addUserBtn').addEventListener('click', addUser);

  /* ---------- INIT ---------- */
  hideAll();
  document.getElementById('loginPage').classList.remove('hidden');
  saveUsers();
};
</script>

</body>
</html>
